{"post_stream":{"posts":[{"id":30790,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-17T04:03:38.680Z","cooked":"\u003cp\u003eMy C++ application ‚Äòasynchronously‚Äô loads a scene that contains a ScriptInstance attached to an otherwise empty node‚Ä¶ it‚Äôs just a simplified test for c++/angelscript interop.\u003cbr\u003e\nI rely on Urho to instantiate the test angelscript object during scene loading‚Ä¶\u003c/p\u003e\n\u003cp\u003eThe following script appears to run without problems in the (old) editor, but when called from a c++ app built against the current master branch (with no changes to the codebase), the commented lines cause Urho to crash when the Update script method ‚Äútries‚Äù to return to Scene::Update‚Ä¶ basically I‚Äôm trying to get access, from within script, to the scene which owns the node which owns the ScriptInstance‚Ä¶\u003c/p\u003e\n\u003cp\u003eNo exception is generated by angelscript - execution of the method always completes, but ‚Äúon the way out‚Äù (as we return to caller Scene::Update) we crash for some odd reason in StringHash equality compare with a clearly corrupted callstack (RAX holds an invalid pointer sourced from a corrupt input parameter on the stackframe).\u003c/p\u003e\n\u003cp\u003eWhat am I doing wrong here, that could cause stack corruption on the c++ call stack?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003eclass Actor:ScriptObject\n{\n\tString actorName=\"zombie1\";\n\tNode@ ownNode_;\n\n\tbool hasTarget_;\n\tActor@ Target_;\n}\n\n\nclass Zombie:Actor\n{\n\tvoid Start(){\n\t\townNode_ = node;\n\t}\n\n\tvoid Update(float dT){\n\t\tPrint(\"Update ZOMBIE: \"+actorName);\n\n\t//\tScene@ myScene = scene;\n//\t\tif(myScene is null)\n//\t\t\treturn;\n\n\t\tPrint(\"DONE!\");\n\t}\u003c/code\u003e\u003c/pre\u003e","post_number":1,"post_type":1,"updated_at":"2019-07-17T04:43:06.403Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":1,"reads":26,"readers_count":25,"score":25.2,"yours":false,"topic_id":5301,"topic_slug":"correct-way-to-access-external-scene-from-as","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":4,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30857,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-19T03:34:41.547Z","cooked":"\u003cp\u003eI did a bit more digging into this issue, starting with a backtrace of the call stack‚Ä¶ with those lines uncommented, the Scene::Update(float) method is crashing just after broadcasting the scene update event‚Ä¶ at that point, the code is attempting to access the Scene::smoothedTransforms_ variantmap, and we crash, evidentally because the Scene has somehow been destroyed, such that ‚Äúthis‚Äù has become an invalid pointer, and as a consequence, accessing any member is an invalid operation.\u003c/p\u003e\n\u003cp\u003eNow I was curious, so I tracked down where the ‚Äúscene‚Äù global is being registered, which is in SceneAPI.cpp:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e    engine-\u0026gt;RegisterGlobalFunction(\"Scene@+ get_scene()\", asFUNCTION(GetScriptContextScene), asCALL_CDECL);\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNote the ‚Äú+‚Äù symbol‚Ä¶ that‚Äôs an auto-handle, my understanding is that the ‚Äú+‚Äù tells angelscript to automatically add one to the RefCount, such that the object in question won‚Äôt be destroyed when it goes out of scope in the script.\u003cbr\u003e\nHowever according to my experiment, accessing the scene global property from script is causing the scene to be garbage collected by angelscript, despite the use of auto handle in the declaration.\u003c/p\u003e\n\u003cp\u003eAm I not understanding something here? \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=9\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\"\u003e\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2019-07-19T03:37:39.671Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":20,"readers_count":19,"score":4.0,"yours":false,"topic_id":5301,"topic_slug":"correct-way-to-access-external-scene-from-as","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30858,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-19T04:31:06.089Z","cooked":"\u003cp\u003eStoring the scene object handle (returned by global property getter) in a script global variable makes the problem go away - since the object reference never goes out of scope, the scene is not destroyed out from under our feet‚Ä¶ this is definitely not an ideal solution.\u003c/p\u003e\n\u003cp\u003eI have to ask myself about this ownership arrangement, whereby querying for access to the container Scene transfers ownership of the Scene object lifetime from C++ to AngelScript‚Ä¶ at least now I know exactly what‚Äôs been going on, even if I don‚Äôt completely understand why things are the way they are (with respect to how we register certain classes with angelscript).\u003c/p\u003e\n\u003cp\u003eI‚Äôm going to mark this workaround as a Solution because it does solve the problem, however I am far from happy with this outcome.\u003c/p\u003e","post_number":3,"post_type":1,"updated_at":"2019-07-20T06:05:12.369Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":20,"readers_count":19,"score":19.0,"yours":false,"topic_id":5301,"topic_slug":"correct-way-to-access-external-scene-from-as","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":2,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30860,"name":"SirNate0","username":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","created_at":"2019-07-19T13:06:33.758Z","cooked":"\u003cp\u003eIs the scene in question stored in a shared pointer somewhere else in your application? It occurs to me that if it‚Äôs not there behavior described might be expected, as when we leave the AngelScript code the ref count would be zero and the scene would be destroyed.\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2019-07-19T13:06:33.758Z","reply_count":1,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":17,"readers_count":16,"score":23.4,"yours":false,"topic_id":5301,"topic_slug":"correct-way-to-access-external-scene-from-as","display_username":"SirNate0","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":false,"staff":false,"user_id":628,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":30863,"name":"Leith Ketchell","username":"Leith","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","created_at":"2019-07-19T15:33:34.196Z","cooked":"\u003cp\u003eYep, the scene is held by a sharedptr within my state manager (implemented as a separate scene and a fistful of custom components).\u003c/p\u003e\n\u003cp\u003e[EDIT]\u003cbr\u003e\nNOPE - On closer inspection, the GamePlayState object is using a raw pointer to store the current game scene - mystery solved! I should know better than to use a raw pointer for a storage type - its acceptable to hand around raw pointers as call arguments, but bad form to use them to hold anything‚Ä¶ mea culpa\u003cbr\u003e\nI had initially considered the possibility that I was not holding onto the scene correctly, and made the very blind assumption that since I had a manager in place, ownership should be clear - but the manager was poorly formed, and is currently undergoing some brutal refactoring and verification - where one egg is bad, there‚Äôs usually more\u003c/p\u003e","post_number":5,"post_type":1,"updated_at":"2019-07-20T06:05:12.521Z","reply_count":0,"reply_to_post_number":4,"quote_count":0,"incoming_link_count":0,"reads":16,"readers_count":15,"score":3.2,"yours":false,"topic_id":5301,"topic_slug":"correct-way-to-access-external-scene-from-as","display_username":"Leith Ketchell","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":3,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"suspended user","title_is_group":false,"reply_to_user":{"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"},"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":1098,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"user_suspended":true,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":true}],"stream":[30790,30857,30858,30860,30863]},"timeline_lookup":[[1,1225],[2,1223]],"suggested_topics":[{"id":7176,"title":"Orthographic scene slowing down when zooming out","fancy_title":"Orthographic scene slowing down when zooming out","slug":"orthographic-scene-slowing-down-when-zooming-out","posts_count":1,"reply_count":0,"highest_post_number":1,"image_url":null,"created_at":"2022-01-30T10:05:50.218Z","last_posted_at":"2022-01-30T10:05:50.294Z","bumped":true,"bumped_at":"2022-01-30T10:05:50.294Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":127,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":1351,"username":"Haukinger","name":"Haukinger","avatar_template":"/user_avatar/discourse.urho3d.io/haukinger/{size}/3670_2.png"}}]},{"id":7105,"title":"Multiple Application.UI Roots?","fancy_title":"Multiple Application.UI Roots?","slug":"multiple-application-ui-roots","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/2X/7/74b10ce575f1b69fe43be4abcb07605d74a1d27c_2_1024x544.jpeg","created_at":"2021-12-20T08:55:14.707Z","last_posted_at":"2021-12-22T02:33:05.795Z","bumped":true,"bumped_at":"2021-12-22T02:33:05.795Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":243,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}},{"extras":null,"description":"Frequent Poster, Accepted Answer","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7112,"title":"What is the proper way to add more source files(.cpp and .h) to a project?","fancy_title":"What is the proper way to add more source files(.cpp and .h) to a project?","slug":"what-is-the-proper-way-to-add-more-source-files-cpp-and-h-to-a-project","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":null,"created_at":"2021-12-27T18:18:21.946Z","last_posted_at":"2021-12-28T12:19:43.514Z","bumped":true,"bumped_at":"2021-12-28T12:19:43.514Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":195,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1498,"username":"Tryout","name":null,"avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/85f322/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7115,"title":"Is it possbile to use one billboard for a lens flare?","fancy_title":"Is it possbile to use one billboard for a lens flare?","slug":"is-it-possbile-to-use-one-billboard-for-a-lens-flare","posts_count":17,"reply_count":4,"highest_post_number":17,"image_url":null,"created_at":"2022-01-02T03:10:48.953Z","last_posted_at":"2022-01-03T21:37:51.953Z","bumped":true,"bumped_at":"2022-01-03T21:37:51.953Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":4,"views":275,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":861,"username":"GodMan","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/e79b87/{size}.png"}},{"extras":null,"description":"Frequent Poster, Accepted Answer","user":{"id":192,"username":"Modanung","name":"È≠îÂ§ßÂÜú ùûçùûéùù≥ ÁèæÊãõËúç","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}}]},{"id":7210,"title":"Shadow Map Coverage Skewed to the Side","fancy_title":"Shadow Map Coverage Skewed to the Side","slug":"shadow-map-coverage-skewed-to-the-side","posts_count":8,"reply_count":5,"highest_post_number":8,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/2X/6/640dc6184f3d70ce00e656555c22db772ea941a4_2_1024x545.jpeg","created_at":"2022-02-28T15:02:02.662Z","last_posted_at":"2022-03-06T04:51:22.096Z","bumped":true,"bumped_at":"2022-03-06T04:51:22.096Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":211,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":null,"description":"Original Poster, Accepted Answer","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":1358,"username":"JSandusky","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/jsandusky/{size}/3220_2.png"}}]}],"tags_descriptions":{},"id":5301,"title":"Correct way to access external Scene from AS","fancy_title":"Correct way to access external Scene from AS","posts_count":5,"created_at":"2019-07-17T04:03:38.622Z","views":282,"reply_count":1,"like_count":3,"last_posted_at":"2019-07-19T15:33:34.196Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"correct-way-to-access-external-scene-from-as","category_id":10,"word_count":722,"deleted_at":null,"user_id":1098,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_5301","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":5,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":2,"show_read_indicator":false,"thumbnails":null,"slow_mode_enabled_until":null,"tags_disable_ads":false,"accepted_answer":{"post_number":5,"username":"Leith","excerpt":"Yep, the scene is held by a sharedptr within my state manager (implemented as a separate scene and a fistful of custom components). \n[EDIT] \nNOPE - On closer inspection, the GamePlayState object is using a raw pointer to store the current game scene - mystery solved! I should know better than to use\u0026hellip;"},"details":{"can_edit":false,"notification_level":1,"participants":[{"id":1098,"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png","post_count":4,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":1},{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2}],"created_by":{"id":1098,"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"},"last_poster":{"id":1098,"username":"Leith","name":"Leith Ketchell","avatar_template":"/user_avatar/discourse.urho3d.io/leith/{size}/2384_2.png"}}}