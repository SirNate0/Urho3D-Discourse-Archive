{"post_stream":{"posts":[{"id":5680,"name":"","username":"Magnetoid","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png","created_at":"2015-04-06T19:48:09.000Z","cooked":"\u003cp\u003eHello All,\u003c/p\u003e\n\u003cp\u003eI‚Äôve been working on a game with Urho3D using the Lua bindings. Recently I added some lua code that removes nodes whose ‚Äúhealth‚Äù value has hit 0. This crashed the engine (as in segfault) in some other lua code which had stored the node in a table. I would expect the entries to be either nil‚Äôd out or have some sort of ‚Äúinvalid‚Äù marker that could be checked, but I haven‚Äôt discovered anything that might work like that. It appears from the C++ code that the node is being deleted (when node:Remove() is called) even though Lua still has pointers to it (hence the segfault later on). Could this be fixed by using sharedptrs for lua references? If not, how can I store nodes in a table safely?\u003c/p\u003e\n\u003cp\u003eHere‚Äôs a short standalone script illustrating the problem (you can run it with Urho3DPlayer in headless mode):\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e\nlocal total = 0\nlocal lastPrintTime = 0\nlocal invalidNodes = {}\n\nfunction Start()\n\tscene_ = Scene()\n\n\t-- Create scene subsystem components\n\tscene_:CreateComponent(\"Octree\", LOCAL)\n\tlocal phys = scene_:CreateComponent(\"PhysicsWorld\", LOCAL)\n\tphys.gravity = Vector3(0,-9.8,0)\n\n\tSubscribeToEvent(\"Update\", \"UpdateStuff\")\n\nend\n\nLifeTimer = ScriptObject()\n\nfunction UpdateStuff()\n\n\tlocal dt = 0.02\n\n\t-- Make sure there are 10 alive objects\n\twhile total \u0026lt; 10 do\n\t\tprint(\"Creating\")\n\t\tlocal newNode = scene_:CreateChild()\n\t\tnewNode:CreateScriptObject(\"LifeTimer\")\n\t\ttotal = total + 1\n\t\tprint(\"Created\")\n\tend\n\n\t-- Print out the table every so often\n\tlastPrintTime = lastPrintTime + dt\n\tif lastPrintTime \u0026gt; 1 then\n\n\t\tfor i,n in ipairs(invalidNodes) do\n\t\t\t-- Problems occur on the next two lines\n\t\t\tprint(\"\u0026gt;\u0026gt;\u0026gt;\u0026gt;\u0026gt; Test:\",n.ID,n.position.x)\n\t\t\tn:SendEvent(\"Junk\")\n\t\tend\n\n\t\tprint(\"Done test\")\n\n\t\tlastPrintTime = lastPrintTime-1\n\tend\n\nend\n\n\nfunction LifeTimer:Start()\n\tself.life = 1.5\n\tself.node.position = Vector3(Random(-10,10),Random(-10,10),Random(-10,10))\n\tprint(\"Start\")\nend\n\nfunction LifeTimer:Stop()\n\tprint(\"Stop\")\nend\n\nfunction LifeTimer:FixedUpdate(dt)\n\tself.life = self.life - dt\n\tif self.life \u0026lt;= 0 then\n\n\t\tprint(\"Removing\")\n\n\t\t-- Add to table before removing\n\t\ttable.insert(invalidNodes, self.node)\n\t\t-- Remove the node\n\t\tself.node:Remove()\n\n\t\tprint(\"Removed\")\n\t\ttotal = total - 1\n\tend\nend\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt might not crash for a while (or it might give Lua errors instead), but Valgrind will show you the problems.\u003cbr\u003e\nI‚Äôm using the git master branch on 64-bit Linux.\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2017-01-02T01:04:34.610Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":11,"reads":3,"readers_count":2,"score":55.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":231,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5686,"name":"","username":"GoogleBot42","avatar_template":"/user_avatar/discourse.urho3d.io/googlebot42/{size}/62_2.png","created_at":"2015-04-06T22:00:38.000Z","cooked":"\u003cp\u003eHmmm maybe there can be a wrapper class that internally keeps track if a pointer to an object is still valid.  IMO lua/anglescript shouldn‚Äôt ever be able to cause a segfault.\u003c/p\u003e","post_number":2,"post_type":1,"updated_at":"2017-01-02T01:04:34.998Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":197,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5689,"name":"Yao Wei Tjong","username":"weitjong","avatar_template":"/user_avatar/discourse.urho3d.io/weitjong/{size}/4_2.png","created_at":"2015-04-07T02:52:30.000Z","cooked":"\u003cp\u003eWelcome to our forum. This has been discussed in the last section on this page here. \u003ca href=\"http://urho3d.github.io/documentation/HEAD/_lua_scripting.html#LuaScripting_Allocation\"\u003eurho3d.github.io/documentation/H ‚Ä¶ Allocation\u003c/a\u003e. Our current Lua/C++ binding does not perform reference counting like AngelScript binding does, so for now you will have to take care yourself to manage the life cycle of your objects correctly.\u003c/p\u003e","post_number":3,"post_type":1,"updated_at":"2017-01-02T01:04:35.218Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"Yao Wei Tjong","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"http://urho3d.github.io/documentation/HEAD/_lua_scripting.html#LuaScripting_Allocation","internal":false,"reflection":false,"title":"Urho3D - Documentation - Lua scripting","clicks":2}],"read":true,"user_title":"Admin","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":4,"hidden":false,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5692,"name":"","username":"GoogleBot42","avatar_template":"/user_avatar/discourse.urho3d.io/googlebot42/{size}/62_2.png","created_at":"2015-04-07T23:32:50.000Z","cooked":"\u003caside class=\"quote\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt width=\"20\" height=\"20\" src=\"https://sjc6.discourse-cdn.com/standard17/user_avatar/discourse.urho3d.io/weitjong/40/4_1.png\" class=\"avatar\"\u003e weitjong:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eOur current Lua/C++ binding does not perform reference counting like AngelScript binding does, so for now you will have to take care yourself to manage the life cycle of your objects correctly.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003e\u003cimg src=\"https://emoji.discourse-cdn.com/twitter/frowning.png?v=5\" title=\":frowning:\" class=\"emoji\" alt=\":frowning:\"\u003e  That is too bad.  I while it would be nice if Lua integration was finished‚Ä¶ I think the other features currently being worked on are much more important though.\u003c/p\u003e\n\u003cp\u003eSo magnetoid I guess you could create a wrapper table that keeps track of if the object is still valid‚Ä¶  You could do this nicely using metatables: \u003ca href=\"http://lua-users.org/wiki/MetamethodsTutorial\" data-bbcode=\"true\" rel=\"nofollow noopener\"\u003ehttp://lua-users.org/wiki/MetamethodsTutorial\u003c/a\u003e\u003c/p\u003e","post_number":4,"post_type":1,"updated_at":"2017-01-02T01:04:35.429Z","reply_count":0,"reply_to_post_number":null,"quote_count":1,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"http://lua-users.org/wiki/MetamethodsTutorial","internal":false,"reflection":false,"title":"lua-users wiki: Metamethods Tutorial","clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":197,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5702,"name":"","username":"Magnetoid","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png","created_at":"2015-04-08T22:35:44.000Z","cooked":"\u003cp\u003eThanks for the replies - I think I might be on to a solution! If I store the node‚Äôs ID instead of a pointer, it cannot be deleted and cause a segfault. Then I can use scene_:GetNode(id) to retreive the pointer back when I need it. Hopefully the lookup performance will be acceptable. The only drawback to this is that the node ID might get reused (what is the probability of that happening? It never happened in the test script). To detect that, I could add some kind of ‚Äúversion‚Äù number on the node, e.g.:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003enode.version = global_version_number\nglobal_version_number = global_version_number + 1\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen when I access it, check for a) the existence of .version, and b) if it matches the value stored with the ID.\u003c/p\u003e\n\u003cp\u003eGoogleBot, your metatable idea would make a nice way to tidy all this up!\u003c/p\u003e\n\u003cp\u003eThis might work, but it would be nice to do it the ‚Äúright‚Äù way. How hard would it be to change the Node* to a SharedPtr in the lua bindings? I imagine it‚Äôs more complicated than simply changing a few pointers. What kind of issues might I run into if I tried this?\u003c/p\u003e","post_number":5,"post_type":1,"updated_at":"2017-01-02T01:04:36.161Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":231,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5703,"name":"","username":"thebluefish","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/f04885/{size}.png","created_at":"2015-04-08T23:11:06.000Z","cooked":"\u003cp\u003eNode IDs inherently don‚Äôt get re-used. When the Node is added to the scene, the scene will assign a new ID if the ID already exists or null (ID = 0).\u003c/p\u003e","post_number":6,"post_type":1,"updated_at":"2017-01-02T01:04:36.225Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":80,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5707,"name":"","username":"GoogleBot42","avatar_template":"/user_avatar/discourse.urho3d.io/googlebot42/{size}/62_2.png","created_at":"2015-04-09T02:36:19.000Z","cooked":"\u003caside class=\"quote no-group\" data-username=\"Magnetoid\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"https://avatars.discourse-cdn.com/v4/letter/m/958977/40.png\" class=\"avatar\"\u003e Magnetoid:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eHow hard would it be to change the Node* to a SharedPtr in the lua bindings? I imagine it‚Äôs more complicated than simply changing a few pointers. What kind of issues might I run into if I tried this?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eI thought about doing it that way but it won‚Äôt work‚Ä¶ The SharedPtr class in Urho3D is not the same as this:\u003ca href=\"http://www.cplusplus.com/reference/memory/shared_ptr/\" data-bbcode=\"true\" rel=\"noopener nofollow ugc\"\u003ehttp://www.cplusplus.com/reference/memory/shared_ptr/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe reason is because the Node itself holds the reference count number because it is derived from the class ‚ÄúObject‚Äù\u003cbr\u003e\nSharedPtr just calls the respective functions from the templated class on construction, destruction, etc.\u003c/p\u003e\n\u003cp\u003eSo the following code won‚Äôt compile because those functions don‚Äôt exist (again these functions that are used for reference counting are defined in the class Object).\u003c/p\u003e\n\u003cp\u003e[code]class Test\u003cbr\u003e\n{\u003cbr\u003e\nvoid Foo() {}\u003cbr\u003e\n};\u003c/p\u003e\n\u003cp\u003eauto testing = SharedPtr( new Test() );[/code]\u003c/p\u003e\n\u003cp\u003eThis means that SharedPtr accesses the object itself to determine the ref count number of the object.  If the object is deleted this memory can now have any value‚Ä¶\u003c/p\u003e\n\u003cp\u003eIn other words‚Ä¶ it won‚Äôt work. \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/frowning.png?v=10\" title=\":frowning:\" class=\"emoji\" alt=\":frowning:\"\u003e\u003c/p\u003e","post_number":7,"post_type":1,"updated_at":"2017-01-02T01:04:36.540Z","reply_count":0,"reply_to_post_number":null,"quote_count":1,"incoming_link_count":0,"reads":4,"readers_count":3,"score":0.8,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"http://www.cplusplus.com/reference/memory/shared_ptr/","internal":false,"reflection":false,"title":"shared_ptr - C++ Reference","clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":197,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5708,"name":"Yao Wei Tjong","username":"weitjong","avatar_template":"/user_avatar/discourse.urho3d.io/weitjong/{size}/4_2.png","created_at":"2015-04-09T06:26:50.000Z","cooked":"\u003cp\u003eTo the OP, I think you are pretty much asking for trouble yourself by trying to use the node object in the later part of your code after you have explicitly call node:Remove() method. If you use node pointer in the table as in your first post and since Lua does not know how to increase the reference count on the object then the pointer becomes bad when the child node is removed. If you use node id in the table then although it is true that it won‚Äôt cause a segfault by itself when the id becomes bad but for sure scene_:GetNode(id) method would return null in the later part of the code when the node originally associated to that id has already been destroyed. I don‚Äôt think there is any easier way for you to safely get hold of a child node in this particular case because there is no way you can increase its reference count in Lua at the moment (until someone refactor our current Lua/C++ binding to move away from tolua++). If you really need the node object again after it has been ‚Äúremoved‚Äù from the scene then perhaps you can workaround the problem currently by simply not calling node:Remove() method, but instead by calling node:SetParent(deadNodeRoot) where deadNodeRoot is the parent of all dead node. This may or may not suitable for your case because the SetParent() method performs some transformation to try retain its world transform after reparenting. Since now the child node is never destroyed, your node pointer in the table should remain valid forever, well, until you destroy the deadNodeRoot parent node or calling its RemoveAllChildren() method to remove all child nodes or RemoveChild() method to remove a particular dead child node for good this time.\u003c/p\u003e","post_number":8,"post_type":1,"updated_at":"2017-01-02T01:04:36.614Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":4,"readers_count":3,"score":0.8,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"Yao Wei Tjong","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Admin","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":4,"hidden":false,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5719,"name":"","username":"GoogleBot42","avatar_template":"/user_avatar/discourse.urho3d.io/googlebot42/{size}/62_2.png","created_at":"2015-04-09T19:40:05.000Z","cooked":"\u003caside class=\"quote\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt width=\"20\" height=\"20\" src=\"https://sjc6.discourse-cdn.com/standard17/user_avatar/discourse.urho3d.io/weitjong/40/4_1.png\" class=\"avatar\"\u003e weitjong:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003e Lua does not know how to increase the reference count on the object then the pointer becomes bad when the child node is removed.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eSorry this really isn‚Äôt that important but‚Ä¶  \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/unamused.png?v=5\" title=\":unamused:\" class=\"emoji\" alt=\":unamused:\"\u003e  Lua doesn‚Äôt reference count at all for garbage collection it uses a much more advanced method but you point still applies.  \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/wink.png?v=5\" title=\":wink:\" class=\"emoji\" alt=\":wink:\"\u003e\u003c/p\u003e","post_number":9,"post_type":1,"updated_at":"2017-01-02T01:04:37.358Z","reply_count":0,"reply_to_post_number":null,"quote_count":1,"incoming_link_count":0,"reads":4,"readers_count":3,"score":0.8,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":197,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5721,"name":"","username":"Magnetoid","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png","created_at":"2015-04-10T01:55:55.000Z","cooked":"\u003caside class=\"quote\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt width=\"20\" height=\"20\" src=\"https://sjc6.discourse-cdn.com/standard17/user_avatar/discourse.urho3d.io/weitjong/40/4_1.png\" class=\"avatar\"\u003e weitjong:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003eTo the OP, I think you are pretty much asking for trouble yourself by trying to use the node object in the later part of your code after you have explicitly call node:Remove() method. ‚Ä¶ If you use node id in the table then although it is true that it won‚Äôt cause a segfault by itself when the id becomes bad but for sure scene_:GetNode(id) method would return null in the later part of the code when the node originally associated to that id has already been destroyed. I don‚Äôt think there is any easier way for you to safely get hold of a child node in this particular case because there is no way you can increase its reference count in Lua at the moment (until someone refactor our current Lua/C++ binding to move away from tolua++). If you really need the node object again after it has been ‚Äúremoved‚Äù from the scene then perhaps you can workaround the problem currently by simply not calling node:Remove() method, but instead by calling node:SetParent(deadNodeRoot) where deadNodeRoot is the parent of all dead node. ‚Ä¶ \u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eI only want to use the node if it is still valid. The GetNode(id) idea seems to be working - it returns NULL instead of a dangling pointer, which is something that can be checked:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003elocal node = scene_:GetNode(id)\nif node then -- Only do this if not NULL.\n    doStuffWithNode(node)\nend\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOtherwise, yes, I would have to do the dead node parent trick as you described (and then implement my own reference counting system so as not to leak them when they are no longer needed).\u003c/p\u003e\n\u003cp\u003e\u003cspan class=\"mention\"\u003e@GoogleBot\u003c/span\u003e, I was referring to Urho3D‚Äôs SharedPtr. I don‚Äôt understand why that can‚Äôt work, since it‚Äôs the same method used by the rest of the engine. If Lua held a SharedPtr, then the node and its reference count must be valid as long as that is alive. To put it another way - instead of using a SharedPtr, just increment the node‚Äôs reference value when it gets passed to lua and decrement it when lua calls the __gc metamethod.\u003c/p\u003e","post_number":10,"post_type":1,"updated_at":"2017-01-02T01:04:37.480Z","reply_count":0,"reply_to_post_number":null,"quote_count":1,"incoming_link_count":0,"reads":4,"readers_count":3,"score":0.8,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":231,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5735,"name":"","username":"GoogleBot42","avatar_template":"/user_avatar/discourse.urho3d.io/googlebot42/{size}/62_2.png","created_at":"2015-04-11T03:43:19.000Z","cooked":"\u003caside class=\"quote no-group\" data-username=\"Magnetoid\"\u003e\n\u003cdiv class=\"title\"\u003e\n\u003cdiv class=\"quote-controls\"\u003e\u003c/div\u003e\n\u003cimg alt=\"\" width=\"20\" height=\"20\" src=\"https://avatars.discourse-cdn.com/v4/letter/m/958977/40.png\" class=\"avatar\"\u003e Magnetoid:\u003c/div\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cspan class=\"mention\"\u003e@GoogleBot\u003c/span\u003e, I was referring to Urho3D‚Äôs SharedPtr. I don‚Äôt understand why that can‚Äôt work, since it‚Äôs the same method used by the rest of the engine. If Lua held a SharedPtr, then the node and its reference count must be valid as long as that is alive. To put it another way - instead of using a SharedPtr, just increment the node‚Äôs reference value when it gets passed to lua and decrement it when lua calls the __gc metamethod.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c/aside\u003e\n\u003cp\u003eSorry I am bad a communicating clearly‚Ä¶  \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/confused.png?v=10\" title=\":confused:\" class=\"emoji\" alt=\":confused:\"\u003e   The reason why it won‚Äôt is because the reference count number is stored in the node itself \u003cem\u003enot\u003c/em\u003e in the SharedPtr.\u003c/p\u003e\n\u003cp\u003eAll nodes and objects derive from RefCount:\u003cbr\u003e\n\u003ca href=\"https://github.com/urho3d/Urho3D/blob/master/Source/Urho3D/Container/RefCounted.h#L47\" data-bbcode=\"true\" rel=\"noopener nofollow ugc\"\u003ehttps://github.com/urho3d/Urho3D/blob/master/Source/Urho3D/Container/RefCounted.h#L47\u003c/a\u003e\u003c/p\u003e","post_number":11,"post_type":1,"updated_at":"2017-01-02T01:04:38.570Z","reply_count":0,"reply_to_post_number":null,"quote_count":1,"incoming_link_count":0,"reads":2,"readers_count":1,"score":0.4,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://github.com/urho3d/Urho3D/blob/master/Source/Urho3D/Container/RefCounted.h#L47","internal":false,"reflection":false,"title":"Urho3D/RefCounted.h at master ¬∑ urho3d/Urho3D ¬∑ GitHub","clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":197,"hidden":false,"trust_level":2,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5741,"name":"","username":"Magnetoid","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png","created_at":"2015-04-11T16:40:55.000Z","cooked":"\u003cpre\u003e\u003ccode class=\"lang-auto\"\u003e    /// Reference count. If below zero, the object has been destroyed.\n    int refs_;\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAs per the code comment, wouldn‚Äôt it be sufficient to keep the refcount above zero to keep the node around? Why not increase it with AddRef() when passing it to lua?\u003c/p\u003e","post_number":12,"post_type":1,"updated_at":"2017-01-02T01:04:38.993Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":2,"readers_count":1,"score":0.4,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":231,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5750,"name":"Yao Wei Tjong","username":"weitjong","avatar_template":"/user_avatar/discourse.urho3d.io/weitjong/{size}/4_2.png","created_at":"2015-04-12T05:29:10.000Z","cooked":"\u003cp\u003eLike I said before, our current Lua/C++ bindings are generated semi-automatically by using tolua++ tool. This tool does not support the concept of reference counting. If you know the tool well, you could probably write a ‚Äúhook‚Äù so that all the generated binding source files do this AddRef() thing when returning a refcounted object to Lua. However, that is not enough. Considering this code snippet.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003elocal node = scene_:GetNode(id)\nlocal another_ref = node\u003c/code\u003e\u003cbr\u003e\nUnless the Lua assignment operator and the whole Lua scripting environment also supports this concept, it is rather pointless just fixing the bindings. And unfortunately, last time I check both AddRef() and ReleaseRef() are not being exposed to scripting API, so you cannot get hold of an object and then manually increase/decrease the reference count in Lua.\u003c/p\u003e\n\u003cp\u003eIf you search our forums or our GitHub issues you should be able to find there were numerous previous discussions on how to fix this. However, discussing it is one thing and actually implementing it is another thing.  \u003cimg src=\"https://emoji.discourse-cdn.com/twitter/wink.png?v=5\" title=\":wink:\" class=\"emoji\" alt=\":wink:\"\u003e\u003c/p\u003e","post_number":13,"post_type":1,"updated_at":"2017-01-02T01:04:39.662Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"Yao Wei Tjong","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":"Admin","title_is_group":false,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":true,"staff":true,"user_id":4,"hidden":false,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false},{"id":5757,"name":"","username":"Magnetoid","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png","created_at":"2015-04-12T19:12:01.000Z","cooked":"\u003cp\u003eOk, I will go poke around some more when I get some free time. One thing I know though is that your code snipped would work fine. In Lua, assignments do not make copies, so they both point to the same thing. Lua‚Äôs GC will only collect (and thus unreference) the node object when all references are gone. So if you ‚Äúcopy‚Äù it to another variable (as in your snippet), nothing changes. Anyway, I‚Äôll mess around with it when I get a chance and I‚Äôll let you guys know if I make any progress. Thanks for your help!\u003c/p\u003e","post_number":14,"post_type":1,"updated_at":"2017-01-02T01:04:40.244Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":0,"reads":3,"readers_count":2,"score":0.6,"yours":false,"topic_id":978,"topic_slug":"invalid-dead-nodes-in-lua-causing-segfaults","display_username":"","primary_group_name":null,"flair_name":null,"flair_url":null,"flair_bg_color":null,"flair_color":null,"version":1,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"read":true,"user_title":null,"bookmarked":false,"actions_summary":[],"moderator":false,"admin":false,"staff":false,"user_id":231,"hidden":false,"trust_level":1,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":false,"can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[5680,5686,5689,5692,5702,5703,5707,5708,5719,5721,5735,5741,5750,5757]},"timeline_lookup":[[1,2787],[4,2786],[5,2785],[9,2784],[11,2783],[13,2782],[14,2781]],"suggested_topics":[{"id":7086,"title":"Handling CrowdAgents that get stuck","fancy_title":"Handling CrowdAgents that get stuck","slug":"handling-crowdagents-that-get-stuck","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2021-12-04T01:26:23.062Z","last_posted_at":"2021-12-05T04:37:54.143Z","bumped":true,"bumped_at":"2021-12-05T04:37:54.143Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":137,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":861,"username":"GodMan","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/e79b87/{size}.png"}}]},{"id":7080,"title":"Build urho3d source on windows 10 - cmake - \"Error in configuration process, project files may be invalid\"","fancy_title":"Build urho3d source on windows 10 - cmake - \u0026ldquo;Error in configuration process, project files may be invalid\u0026rdquo;","slug":"build-urho3d-source-on-windows-10-cmake-error-in-configuration-process-project-files-may-be-invalid","posts_count":8,"reply_count":4,"highest_post_number":8,"image_url":null,"created_at":"2021-12-03T01:55:53.267Z","last_posted_at":"2021-12-06T22:46:59.584Z","bumped":true,"bumped_at":"2021-12-06T22:46:59.584Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":1,"views":324,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":null,"description":"Original Poster","user":{"id":1488,"username":"ToolmakerSteve","name":"ToolmakerSteve","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/ba9def/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":"latest","description":"Most Recent Poster","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}}]},{"id":7123,"title":"Character hitboxes","fancy_title":"Character hitboxes","slug":"character-hitboxes","posts_count":24,"reply_count":16,"highest_post_number":24,"image_url":null,"created_at":"2022-01-10T19:34:24.617Z","last_posted_at":"2022-01-12T22:44:20.744Z","bumped":true,"bumped_at":"2022-01-12T22:44:20.744Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":275,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":861,"username":"GodMan","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/g/e79b87/{size}.png"}},{"extras":null,"description":"Frequent Poster, Accepted Answer","user":{"id":192,"username":"Modanung","name":"È≠îÂ§ßÂÜú ùûçùûéùù≥ ÁèæÊãõËúç","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":484,"username":"Eugene","name":"Eugene Kozlov","avatar_template":"/user_avatar/discourse.urho3d.io/eugene/{size}/902_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":247,"username":"Dave82","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/dave82/{size}/2369_2.png"}}]},{"id":7132,"title":"How to Draw Anti-Aliased Outlined Line on the UI layer?","fancy_title":"How to Draw Anti-Aliased Outlined Line on the UI layer?","slug":"how-to-draw-anti-aliased-outlined-line-on-the-ui-layer","posts_count":8,"reply_count":5,"highest_post_number":8,"image_url":"https://global.discourse-cdn.com/standard17/uploads/urho3d/optimized/2X/c/c040fdbc2f1856c238ba6328fd7f5ff80b15858f_2_782x1024.jpeg","created_at":"2022-01-17T22:08:06.874Z","last_posted_at":"2022-01-20T20:13:30.614Z","bumped":true,"bumped_at":"2022-01-20T20:13:30.614Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":3,"views":173,"category_id":10,"featured_link":null,"has_accepted_answer":true,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1334,"username":"najak3d","name":"Brian Knox","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/n/6a8cbe/{size}.png"}},{"extras":null,"description":"Frequent Poster, Accepted Answer","user":{"id":631,"username":"JTippetts1","name":"J Tippetts","avatar_template":"/user_avatar/discourse.urho3d.io/jtippetts1/{size}/96_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":628,"username":"SirNate0","name":"SirNate0","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/s/9f8e36/{size}.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":192,"username":"Modanung","name":"È≠îÂ§ßÂÜú ùûçùûéùù≥ ÁèæÊãõËúç","avatar_template":"/user_avatar/discourse.urho3d.io/modanung/{size}/3290_2.png"}}]},{"id":7263,"title":"Is Steam integration like this possible?","fancy_title":"Is Steam integration like this possible?","slug":"is-steam-integration-like-this-possible","posts_count":4,"reply_count":0,"highest_post_number":4,"image_url":null,"created_at":"2022-05-12T22:06:15.739Z","last_posted_at":"2022-05-14T22:02:38.197Z","bumped":true,"bumped_at":"2022-05-14T22:02:38.197Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags_descriptions":{},"like_count":0,"views":202,"category_id":10,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":1292,"username":"evolgames","name":"evol","avatar_template":"/user_avatar/discourse.urho3d.io/evolgames/{size}/3169_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":1358,"username":"JSandusky","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/jsandusky/{size}/3220_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":184,"username":"Enhex","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/enhex/{size}/81_2.png"}}]}],"tags_descriptions":{},"id":978,"title":"Invalid/Dead nodes in Lua causing segfaults","fancy_title":"Invalid/Dead nodes in Lua causing segfaults","posts_count":14,"created_at":"2015-04-06T19:48:09.000Z","views":260,"reply_count":0,"like_count":0,"last_posted_at":"2015-04-12T19:12:01.000Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"invalid-dead-nodes-in-lua-causing-segfaults","category_id":10,"word_count":2173,"deleted_at":null,"user_id":231,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_978","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":14,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"bookmarks":[],"topic_timer":null,"message_bus_last_id":0,"participant_count":4,"show_read_indicator":false,"thumbnails":null,"slow_mode_enabled_until":null,"tags_disable_ads":false,"details":{"can_edit":false,"notification_level":1,"participants":[{"id":197,"username":"GoogleBot42","name":"","avatar_template":"/user_avatar/discourse.urho3d.io/googlebot42/{size}/62_2.png","post_count":5,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":2},{"id":231,"username":"Magnetoid","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png","post_count":5,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":1},{"id":4,"username":"weitjong","name":"Yao Wei Tjong","avatar_template":"/user_avatar/discourse.urho3d.io/weitjong/{size}/4_2.png","post_count":3,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"admin":true,"trust_level":4},{"id":80,"username":"thebluefish","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/t/f04885/{size}.png","post_count":1,"primary_group_name":null,"flair_name":null,"flair_url":null,"flair_color":null,"flair_bg_color":null,"trust_level":1}],"created_by":{"id":231,"username":"Magnetoid","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png"},"last_poster":{"id":231,"username":"Magnetoid","name":"","avatar_template":"https://avatars.discourse-cdn.com/v4/letter/m/958977/{size}.png"},"links":[{"url":"http://urho3d.github.io/documentation/HEAD/_lua_scripting.html#LuaScripting_Allocation","title":"Urho3D - Documentation - Lua scripting","internal":false,"attachment":false,"reflection":false,"clicks":2,"user_id":4,"domain":"urho3d.github.io","root_domain":"urho3d.github.io"}]}}